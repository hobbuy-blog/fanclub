<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Hobbuy-Blog, bockring">
  <title>パスワードリセット | Hobbuy Blog ファンクラブ</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    html {
      scroll-padding-top: 100px;
    }
    body {
      font-family: "Yu Gothic", "Meiryo", "MS PGothic", "Osaka", "Hiragino Kaku Gothic Pro", sans-serif;
      background: #fafafa;
      color: #222;
      margin: 2rem auto;
      max-width: 700px;
      padding: 1rem;
      line-height: 1.7;
      padding-top: 70px;
    }
    h1, h2 {
      font-weight: bold;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.3em;
    }
    a {
      color: #0055a4;
    }
    header {
      background-color: #333;
      color: #fff;
      padding: 0.5em 0.25em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }
    .site-title {
      color: #fff;
      font-size: 1em;
      letter-spacing: 0px;
    }
    .site-title a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    nav {
      margin-left: 2em;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      margin: 0 1em;
      font-weight: 500;
      transition: color 0.2s;
    }
    nav a:hover {
      color: rgba(255,255,255,0.75);
    }

    .form-container {
      background: #fff;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 2em;
    }
    .form-group {
      margin-bottom: 1.5em;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5em;
      font-weight: 500;
    }
    .form-group input[type="email"],
    .form-group input[type="password"] {
      width: 100%;
      padding: 0.7em;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1em;
      box-sizing: border-box;
    }
    .form-group input[type="email"]:focus,
    .form-group input[type="password"]:focus {
      outline: none;
      border-color: #0055a4;
    }
    .recaptcha-container {
      margin-bottom: 1.5em;
      display: flex;
      justify-content: center;
    }
    .submit-btn {
      width: 100%;
      padding: 1em;
      background-color: #0055a4;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1.1em;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .submit-btn:hover {
      background-color: #003d7a;
    }
    .submit-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .message {
      padding: 1em;
      border-radius: 4px;
      margin-bottom: 1em;
      display: none;
    }
    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .message.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .required {
      color: #f20;
    }
    .info-box {
      background: #f9f9f9;
      padding: 1em;
      border-left: 4px solid #0055a4;
      margin-bottom: 1.5em;
      font-size: 0.95em;
    }
    .links-container {
      text-align: center;
      margin-top: 1.5em;
      padding-top: 1.5em;
      border-top: 1px solid #ddd;
    }
    .links-container a {
      margin: 0 1em;
    }
    .password-strength {
      font-size: 0.85em;
      margin-top: 0.3em;
      color: #666;
    }
    #resetForm {
      display: block;
    }
    #newPasswordSection {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="site-title"><a href="../index.html"><b style="font-size: 1.5em;">Hobbuy Blog</b><br><b><small>Fan Club</small></b></a></div>
    <nav>
      <a href="./login.html">ログイン</a>
    </nav>
  </header>

  <h2>パスワードリセット</h2>

  <div id="statusMessage" class="message"></div>

  <!-- Step 1: メールアドレス入力 -->
  <div class="form-container" id="emailSection">
    <div class="info-box">
      <strong>パスワードをお忘れですか？</strong><br>
      登録済みのメールアドレスを入力してください．リセット用の認証コードをお送りします．
    </div>
    
    <form id="resetForm">
      <div class="form-group">
        <label for="email">メールアドレス <span class="required">*</span></label>
        <input type="email" id="email" name="email" required placeholder="example@email.com">
      </div>

      <div class="recaptcha-container">
        <div class="g-recaptcha" data-sitekey="6LdcGA8sAAAAAGV3YKHoPvDK_4yoNuedWM1FlRWv"></div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">リセットコードを送信</button>
    </form>

    <div class="links-container">
      <a href="./login.html">ログインページへ戻る</a>
      <a href="./register.html">新規会員登録</a>
    </div>
  </div>

  <!-- Step 2: 認証コードと新しいパスワード入力 -->
  <div class="form-container" id="newPasswordSection">
    <div class="info-box">
      メールに送信された6桁の認証コードと，新しいパスワードを入力してください．
    </div>
    
    <form id="newPasswordForm">
      <div class="form-group">
        <label for="verificationCode">認証コード（6桁） <span class="required">*</span></label>
        <input type="text" id="verificationCode" name="verificationCode" required 
               pattern="[0-9]{6}" maxlength="6" placeholder="123456"
               style="width: 100%; padding: 0.7em; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box;">
      </div>

      <div class="form-group">
        <label for="newPassword">新しいパスワード <span class="required">*</span></label>
        <input type="password" id="newPassword" name="newPassword" required minlength="8" placeholder="8文字以上">
        <div id="passwordStrength" class="password-strength"></div>
      </div>

      <div class="form-group">
        <label for="confirmNewPassword">新しいパスワード（確認） <span class="required">*</span></label>
        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required minlength="8" placeholder="もう一度入力">
      </div>

      <button type="submit" class="submit-btn" id="resetPasswordBtn">パスワードをリセット</button>
    </form>

    <div class="links-container">
      <a href="#" id="backToEmailBtn">メールアドレス入力に戻る</a>
    </div>
  </div>

  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyA0BVdikPhww1qvKfLQBDIejf3En20zHnU",
      authDomain: "hobbuy-blog-fan.firebaseapp.com",
      databaseURL: "https://hobbuy-blog-fan-default-rtdb.firebaseio.com",
      projectId: "hobbuy-blog-fan",
      storageBucket: "hobbuy-blog-fan.firebasestorage.app",
      messagingSenderId: "957393727956",
      appId: "1:957393727956:web:123cb8792e256b8ca22641",
      measurementId: "G-RHVS30RRQZ"
    };

    // Firebase初期化
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // EmailJS初期化
    emailjs.init("huwikhPrEgQGUlhwI");

    // グローバル変数
    let resetEmail = '';
    let resetUserId = '';
    let resetCode = '';

    // メッセージ表示
    const statusMessage = document.getElementById('statusMessage');
    function showMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = `message ${type}`;
      statusMessage.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 6桁の認証コード生成
    function generateVerificationCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Step 1: メールアドレス送信
    const resetForm = document.getElementById('resetForm');
    const submitBtn = document.getElementById('submitBtn');

    resetForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      // reCAPTCHA確認
      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) {
        showMessage('reCAPTCHA認証を完了してください．', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = '送信中...';

      try {
        const email = document.getElementById('email').value;
        resetEmail = email;

        // メールアドレスでユーザーを検索
        const userSnapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
        
        if (!userSnapshot.exists()) {
          showMessage('このメールアドレスは登録されていません．', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'リセットコードを送信';
          grecaptcha.reset();
          return;
        }

        // ユーザーIDを取得
        userSnapshot.forEach(child => {
          resetUserId = child.key;
        });

        // 6桁の認証コード生成
        resetCode = generateVerificationCode();

        // 認証コードをFirebaseに保存（有効期限30分）
        const expiresAt = new Date(Date.now() + 30 * 60 * 1000).toISOString();
        await database.ref('passwordResets/' + resetUserId).set({
          email: email,
          code: resetCode,
          expiresAt: expiresAt,
          createdAt: new Date().toISOString()
        });

        // EmailJS経由で認証コードを送信
        await emailjs.send('service_70cfhpd', 'passwordReset', {
          to_email: email,
          verification_code: resetCode,
          message: 'パスワードリセット用の認証コードです．このコードは30分間有効です．'
        });

        showMessage('認証コードをメールに送信しました．メールをご確認ください．', 'success');
        
        // Step 2の画面に切り替え
        document.getElementById('emailSection').style.display = 'none';
        document.getElementById('newPasswordSection').style.display = 'block';

      } catch (error) {
        console.error('送信エラー:', error);
        showMessage('送信中にエラーが発生しました．もう一度お試しください．', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'リセットコードを送信';
        grecaptcha.reset();
      }
    });

    // パスワード強度チェック
    const newPasswordInput = document.getElementById('newPassword');
    const passwordStrength = document.getElementById('passwordStrength');

    newPasswordInput.addEventListener('input', function() {
      const password = this.value;
      let strength = '';
      
      if (password.length === 0) {
        strength = '';
      } else if (password.length < 8) {
        strength = '弱い（8文字以上必要）';
        passwordStrength.style.color = '#f20';
      } else if (password.length < 12) {
        strength = '普通';
        passwordStrength.style.color = '#ff9800';
      } else {
        strength = '強い';
        passwordStrength.style.color = '#4caf50';
      }
      
      passwordStrength.textContent = strength ? `強度: ${strength}` : '';
    });

    // Step 2: 新しいパスワード設定
    const newPasswordForm = document.getElementById('newPasswordForm');
    const resetPasswordBtn = document.getElementById('resetPasswordBtn');

    newPasswordForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const verificationCode = document.getElementById('verificationCode').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;

      // パスワード確認
      if (newPassword !== confirmNewPassword) {
        showMessage('パスワードが一致しません．', 'error');
        return;
      }

      resetPasswordBtn.disabled = true;
      resetPasswordBtn.textContent = 'リセット中...';

      try {
        // 認証コードの確認
        const resetSnapshot = await database.ref('passwordResets/' + resetUserId).once('value');
        
        if (!resetSnapshot.exists()) {
          showMessage('認証コードの有効期限が切れています．最初からやり直してください．', 'error');
          resetPasswordBtn.disabled = false;
          resetPasswordBtn.textContent = 'パスワードをリセット';
          return;
        }

        const resetData = resetSnapshot.val();
        
        // 有効期限チェック
        if (new Date(resetData.expiresAt) < new Date()) {
          showMessage('認証コードの有効期限が切れています．最初からやり直してください．', 'error');
          await database.ref('passwordResets/' + resetUserId).remove();
          resetPasswordBtn.disabled = false;
          resetPasswordBtn.textContent = 'パスワードをリセット';
          return;
        }

        // 認証コード確認
        if (resetData.code !== verificationCode) {
          showMessage('認証コードが正しくありません．', 'error');
          resetPasswordBtn.disabled = false;
          resetPasswordBtn.textContent = 'パスワードをリセット';
          return;
        }

        // パスワードを更新
        await database.ref('users/' + resetUserId).update({
          password: btoa(newPassword)
        });

        // 使用済みの認証コードを削除
        await database.ref('passwordResets/' + resetUserId).remove();

        showMessage('パスワードをリセットしました！新しいパスワードでログインしてください．', 'success');
        
        // 3秒後にログインページへリダイレクト
        setTimeout(() => {
          window.location.href = './login.html';
        }, 3000);

      } catch (error) {
        console.error('リセットエラー:', error);
        showMessage('リセット中にエラーが発生しました．もう一度お試しください．', 'error');
        resetPasswordBtn.disabled = false;
        resetPasswordBtn.textContent = 'パスワードをリセット';
      }
    });

    // メールアドレス入力に戻る
    document.getElementById('backToEmailBtn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('emailSection').style.display = 'block';
      document.getElementById('newPasswordSection').style.display = 'none';
      document.getElementById('resetForm').reset();
      grecaptcha.reset();
      statusMessage.style.display = 'none';
    });
  </script>
</body>
</html>
